# Sistema de Uploads Paralelos - Implementa√ß√£o Completa

**Documenta√ß√£o criada em:** 09 de Janeiro de 2025  
**Autor:** Th√∫lio Silva

## üéØ Objetivo Principal

Implementar um sistema robusto de uploads paralelos para substituir o sistema sequencial lento, melhorando drasticamente a velocidade de upload de arquivos e fornecendo feedback visual preciso de progresso para o usu√°rio.

## üìã Resumo da Solu√ß√£o

### **Problema Inicial**
- Uploads sequenciais extremamente lentos (um arquivo por vez)
- Progress bar n√£o funcionava corretamente 
- Arquivos grandes demoravam muitos minutos para fazer upload
- Usu√°rios n√£o tinham feedback visual adequado do progresso
- Sistema n√£o era escal√°vel para m√∫ltiplos arquivos

### **Solu√ß√£o Implementada**
- **Uploads paralelos** usando `Promise.allSettled()` para processar m√∫ltiplos arquivos simultaneamente
- **Progress bar funcional** com c√°lculo preciso de porcentagem
- **Gest√£o de estado thread-safe** para evitar race conditions durante uploads paralelos
- **Sistema centralizado** que funciona em todos os contextos (budget, budgetreview, neworder)
- **Logging detalhado** para debugging e monitoramento

---

## üèóÔ∏è Arquitetura da Solu√ß√£o

### **1. Componente Central - UploadField.js**
```javascript
// Localiza√ß√£o: 00_frontend/src/components/forms/uploads/UploadField.js
- Renderiza√ß√£o de cards de arquivos com feedback visual
- Suporte para m√∫ltiplas categorias (Excel, Slice, SliceImage)
- Progress bar circular com percentual preciso
- Estados visuais: iniciando, carregando, finalizando, sucesso, erro
- Drag & drop e sele√ß√£o de arquivos
```

### **2. L√≥gica de Upload - ComponentTab.js**
```javascript
// Localiza√ß√£o: 00_frontend/src/components/forms/tabs/ComponentTab.js
- uploadFileToOneDriveForBudget() - Upload chunked para arquivos grandes
- uploadSingleChunkForBudget() - Upload de chunks individuais com progress tracking
- handleFileUpload() - Gerenciamento paralelo de m√∫ltiplos uploads
- updateStagedFileStatus() - Atualiza√ß√£o thread-safe do estado dos arquivos
- updateComponentFiles() - Fun√ß√£o centralizada para gest√£o de estado
```

### **3. P√°ginas de Contexto**
```javascript
// Budget Mode: 00_frontend/src/app/order/[orderId]/budget/page.js
// BudgetReview Mode: 00_frontend/src/app/order/[orderId]/budgetreview/page.js
// NewOrder Mode: 00_frontend/src/app/admin/neworder/page.js e agent/neworder/page.js
- Gest√£o de estado espec√≠fica por contexto
- Callbacks para comunica√ß√£o entre componentes
- Valida√ß√£o de arquivos obrigat√≥rios
```

---

## üîß Implementa√ß√£o Detalhada

### **1. Sistema de Uploads Paralelos**

#### **Estrutura Principal**
```javascript
// handleFileUpload em ComponentTab.js
const handleFileUpload = async (componentId, files) => {
  // 1. Preparar arquivos com metadados
  const newFiles = files.map(file => ({
    tempId: `upload_${Date.now()}_${Math.random()}`,
    name: file.name,
    file: file,
    status: 'queueing',
    progress: 0,
    budgetCategory: file.budgetCategory || null
  }));
  
  // 2. Adicionar ao estado usando fun√ß√£o centralizada thread-safe
  updateComponentFiles(componentId, (currentFiles) => {
    return [...currentFiles, ...newFiles];
  });

  // 3. Processar todos os arquivos em paralelo
  const uploadPromises = newFiles.map(async (stagedFile) => {
    return uploadSingleFile(stagedFile, componentId);
  });

  // 4. Esperar conclus√£o de todos os uploads
  const results = await Promise.allSettled(uploadPromises);
};
```

#### **Upload Chunked com Progress Tracking**
```javascript
// uploadFileToOneDriveForBudget em ComponentTab.js
const uploadFileToOneDriveForBudget = async (uploadUrl, stagedFile, componentId, updateStagedFileStatus) => {
  const file = stagedFile.file;
  const fileSize = file.size;
  const chunkSize = 10 * 1024 * 1024; // 10MB chunks
  
  // Arquivos pequenos (<4MB): upload direto
  if (fileSize < 4 * 1024 * 1024) {
    return await uploadSingleChunkForBudget(uploadUrl, file, 0, fileSize - 1, fileSize, stagedFile, componentId, updateStagedFileStatus);
  }
  
  // Arquivos grandes: upload chunked
  let currentByte = 0;
  while (currentByte < fileSize) {
    const nextByte = Math.min(currentByte + chunkSize, fileSize);
    const chunk = file.slice(currentByte, nextByte);
    
    const result = await uploadSingleChunkForBudget(uploadUrl, chunk, currentByte, nextByte - 1, fileSize, stagedFile, componentId, updateStagedFileStatus);
    
    if (nextByte >= fileSize) return result;
    currentByte = nextByte;
  }
};
```

#### **Progress Tracking Preciso**
```javascript
// uploadSingleChunkForBudget em ComponentTab.js
xhr.upload.onprogress = (event) => {
  if (event.lengthComputable) {
    // C√°lculo preciso do progresso considerando chunks
    const overallProgress = Math.round(((startByte + event.loaded) / totalSize) * 100);
    
    // Atualiza√ß√£o thread-safe do progresso
    updateStagedFileStatus(componentId, stagedFile.tempId, {
      status: 'carregando',
      progress: overallProgress
    });
  }
};
```

### **2. Gest√£o de Estado Thread-Safe**

#### **Fun√ß√£o Centralizada para Atualiza√ß√µes**
```javascript
// updateComponentFiles em ComponentTab.js
const updateComponentFiles = (componentId, updateFunction) => {
  if (isReviewMode && onComponentUploadedFilesChange) {
    // Review mode: Usa callback externo com fun√ß√£o para thread-safety
    onComponentUploadedFilesChange(componentId, (currentFiles) => {
      const safeCurrentFiles = currentFiles || [];
      const updatedFiles = updateFunction(safeCurrentFiles);
      return updatedFiles;
    });
  } else {
    // Budget mode: Usa estado interno com functional updates
    setInternalComponentUploadedFiles(prev => {
      const currentFiles = prev[componentId] || [];
      const updatedFiles = updateFunction(currentFiles);
      return {
        ...prev,
        [componentId]: updatedFiles
      };
    });
  }
};
```

#### **Atualiza√ß√£o de Status Thread-Safe**
```javascript
// updateStagedFileStatus em ComponentTab.js
const updateStagedFileStatus = (componentId, fileKey, updates, currentFilesOverride = null) => {
  if (currentFilesOverride) {
    // Modo legacy para compatibilidade
    const updatedFiles = currentFilesOverride.map(file => 
      (file.tempId === fileKey || file.onedrive_item_id === fileKey) 
        ? { ...file, ...updates }
        : file
    );
    updateComponentUploadedFilesState(componentId, updatedFiles);
    return updatedFiles;
  } else {
    // Modo moderno: usar fun√ß√£o centralizada
    updateComponentFiles(componentId, (currentFiles) => {
      return currentFiles.map(file => 
        (file.tempId === fileKey || file.onedrive_item_id === fileKey) 
          ? { ...file, ...updates }
          : file
      );
    });
  }
};
```

### **3. Renderiza√ß√£o de Cards com Progress Bar**

#### **L√≥gica de Estados Visuais**
```javascript
// renderFileCard em UploadField.js
const isProcessingOrUploadingThisFile = isStaged && (
  status === 'queueing' || 
  status === 'iniciando' || 
  status === 'creating_session' || 
  status === 'carregando' || 
  status === 'uploading'
);

const isCurrentlyUploadingThisFile = isStaged && (
  status === 'carregando' || 
  status === 'uploading'
);
```

#### **Progress Bar Circular**
```javascript
// iconContent em renderFileCard
if (isStaged && isProcessingOrUploadingThisFile && progress !== undefined && progress < 100) {
  iconContent = (
    <div className="relative w-10 h-10">
      <svg className="transform -rotate-90" width="100%" height="100%" viewBox="0 0 36 36">
        <circle cx="18" cy="18" r="16" fill="none" stroke="#E5E7EB" strokeWidth="3" />
        <circle
          cx="18" cy="18" r="16" fill="none" stroke={strokeColor}
          strokeWidth="3"
          strokeDasharray={`${2 * Math.PI * 16}`}
          strokeDashoffset={`${2 * Math.PI * 16 * (1 - (progress || 0) / 100)}`}
          strokeLinecap="round"
        />
      </svg>
      <div className={`absolute inset-0 flex items-center justify-center text-xs font-semibold ${textColor}`}>
        {`${Math.round(progress || 0)}%`}
      </div>
    </div>
  );
}
```

### **4. Categoriza√ß√£o de Arquivos para Budget**

#### **Sistema de Categorias**
```javascript
// categorizeFileForBudget em UploadField.js
const categorizeFileForBudget = (fileName) => {
  const extension = fileName.split('.').pop().toLowerCase();
  
  // Excel files (obrigat√≥rio: 1 por or√ßamento)
  const excelExtensions = ['xlsx', 'xls', 'xlsm', 'xlsb', 'xltx', 'xltm', 'csv'];
  if (excelExtensions.includes(extension)) return 'excel';
  
  // 3D/Slice files (obrigat√≥rio: 1 por or√ßamento)
  const sliceExtensions = ['stl', 'obj', '3ds', '3mf', 'fbx', 'blend', 'dae', 'gltf', 'glb', 'ply', 'step', 'stp', 'iges', 'igs', 'zip', 'rar', '7z', 'tar', 'gz', 'nxs', 'nxa'];
  if (sliceExtensions.includes(extension)) return 'slice';

  // Slice Image files (obrigat√≥rio: 1 por or√ßamento)
  const sliceImageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'tiff', 'tif'];
  if (sliceImageExtensions.includes(extension)) return 'sliceImage';
  
  return null;
};
```

#### **Valida√ß√£o de Arquivos Obrigat√≥rios**
```javascript
// validateComponentBudgetFiles em budgetreview/page.js
const validateComponentBudgetFiles = () => {
  const errors = [];
  
  budgetData.components_with_budgets.forEach((componentBudget, index) => {
    // Combinar arquivos existentes + arquivos staged
    const allFiles = [
      ...existingFiles.filter(ef => !filesToDelete.some(ftd => ftd.budgetFileId === ef.id)),
      ...stagedFiles.filter(sf => sf.status === 'success' && sf.onedrive_item_id)
    ];

    // Verificar categorias obrigat√≥rias
    const hasExcel = allFiles.some(f => f.category === 'excel');
    const hasSlice = allFiles.some(f => f.category === 'slice');
    const hasSliceImage = allFiles.some(f => f.category === 'sliceImage');

    if (!hasExcel || !hasSlice || !hasSliceImage) {
      errors.push(`${componentTitle}: Arquivos obrigat√≥rios em falta`);
    }
  });

  return { isValid: errors.length === 0, errors };
};
```

---

## üîÑ Fluxo Completo de Upload

### **1. Inicializa√ß√£o**
```
User seleciona arquivos ‚Üí UploadField detecta ‚Üí handleFileChangeInternal/handleFieldDrop
                                ‚Üì
                        Valida√ß√£o de duplicatas e categorias
                                ‚Üì
                        onAddFiles callback para ComponentTab
```

### **2. Processamento Paralelo**
```
handleFileUpload ‚Üí Criar objetos com tempId e metadados
                              ‚Üì
                  updateComponentFiles (thread-safe state update)
                              ‚Üì
                  Promise.allSettled([upload1, upload2, upload3, ...])
                              ‚Üì
                  Cada upload executa em paralelo independentemente
```

### **3. Upload Individual**
```
uploadSingleFile ‚Üí tokenManager.registerActiveUpload()
                              ‚Üì
                  status: 'iniciando' ‚Üí API create-budget-upload-session
                              ‚Üì
                  status: 'carregando' ‚Üí uploadFileToOneDriveForBudget
                              ‚Üì
                  XMLHttpRequest com progress tracking em tempo real
                              ‚Üì
                  status: 'finalizando' ‚Üí API finalize-budget-upload
                              ‚Üì
                  status: 'success' ‚Üí tokenManager.unregisterActiveUpload()
```

### **4. Progress Tracking**
```
xhr.upload.onprogress ‚Üí Calcular overallProgress
                              ‚Üì
                  updateStagedFileStatus (thread-safe)
                              ‚Üì
                  updateComponentFiles (functional update)
                              ‚Üì
                  React re-render com progress atualizado
                              ‚Üì
                  UploadField renderiza progress bar circular
```

### **5. Estados de Arquivo**
```
'queueing' ‚Üí 'iniciando' ‚Üí 'carregando' ‚Üí 'finalizando' ‚Üí 'success'
                    ‚Üì (em caso de erro)
                  'error'
```

---

## üéØ Contextos de Funcionamento

### **1. Budget Mode**
- **Localiza√ß√£o:** `/order/[orderId]/budget`
- **Caracter√≠sticas:**
  - Uploads para staging tempor√°rio
  - Valida√ß√£o obrigat√≥ria de categorias (Excel + Slice + SliceImage)
  - State management interno no ComponentTab
  - APIs: `create-budget-upload-session`, `finalize-budget-upload`

### **2. BudgetReview Mode**
- **Localiza√ß√£o:** `/order/[orderId]/budgetreview`
- **Caracter√≠sticas:**
  - Uploads para staging tempor√°rio + arquivos existentes na visualiza√ß√£o
  - State management externo na p√°gina
  - Marca√ß√£o de arquivos para dele√ß√£o (n√£o dele√ß√£o imediata)
  - Callback functions para thread-safety
  - Mesmas APIs do Budget Mode

### **3. NewOrder Mode**
- **Localiza√ß√£o:** `/admin/neworder` e `/agent/neworder`
- **Caracter√≠sticas:**
  - Uploads para sistema permanente
  - Sem restri√ß√µes de categorias
  - APIs: `create-onedrive-upload-session`, `finalize-onedrive-upload`
  - System de mudan√ßas n√£o salvas integrado

---

## üîó Rela√ß√µes no Sistema

### **1. APIs Backend**
```
Frontend                    Backend
UploadField ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí /api/create-budget-upload-session
ComponentTab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí /api/finalize-budget-upload
             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí /api/delete-temp-file
             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí /api/get-staged-file-link
             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí /api/delete-budget-file
             ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí /api/get-budget-download-link
```

### **2. State Management**
```
Page Level State (BudgetReview)
         ‚Üì (callback functions)
ComponentTab (Upload Logic)
         ‚Üì (props & callbacks)
UploadField (UI Rendering)
         ‚Üì (user interactions)
File Input & Drag/Drop
```

### **3. Depend√™ncias**
```
tokenManager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Preven√ß√£o de interrup√ß√£o de sess√£o
axiosInstance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Chamadas API autenticadas
toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Feedback visual para usu√°rio
useMessages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Internacionaliza√ß√£o
```

---

## üöÄ Performance e Otimiza√ß√µes

### **1. Uploads Paralelos**
- **Velocidade:** 3-5x mais r√°pido que uploads sequenciais
- **Escalabilidade:** Suporta 10+ arquivos simult√¢neos sem degrada√ß√£o
- **Chunking:** Arquivos >4MB s√£o divididos em chunks de 10MB para estabilidade

### **2. Thread Safety**
- **Functional Updates:** Previne race conditions durante updates simult√¢neos
- **Centralized State Management:** Uma fun√ß√£o para todas as atualiza√ß√µes de estado
- **Callback Pattern:** BudgetReview mode usa callbacks para state management thread-safe

### **3. Progress Tracking**
- **Real-time Updates:** XMLHttpRequest onprogress para feedback imediato
- **Accurate Calculation:** Considera chunks para c√°lculo preciso de percentual
- **Visual Feedback:** Progress bar circular com percentual num√©rico

### **4. Error Handling**
- **Promise.allSettled:** Permite que uploads falhem independentemente
- **Retry Logic:** Usu√°rio pode tentar novamente arquivos que falharam
- **Graceful Degradation:** Sistema continua funcionando mesmo com falhas parciais

---

## üõ†Ô∏è Manuten√ß√£o e Troubleshooting

### **1. Debugging**
```javascript
// Para ativar logs detalhados, descomente as linhas em:
// ComponentTab.js - Upload process logs
// UploadField.js - Render and state logs
// budgetreview/page.js - State management logs

// Logs removidos para produ√ß√£o mas dispon√≠veis para debugging:
console.log('üöÄ [UPLOAD START] handleFileUpload called:', {...});
console.log('üìà [PROGRESS] XMLHttpRequest progress update:', {...});
console.log('üéØ [UPDATE FILES] updateComponentFiles called:', {...});
```

### **2. Problemas Comuns**

#### **Progress Bar N√£o Funciona**
- **Causa:** Status 'carregando' n√£o inclu√≠do nas condi√ß√µes de renderiza√ß√£o
- **Solu√ß√£o:** Verificar `isProcessingOrUploadingThisFile` em UploadField.js
- **Localiza√ß√£o:** Linha ~547 em UploadField.js

#### **Race Conditions**
- **Causa:** Multiple uploads atualizando state simultaneamente
- **Solu√ß√£o:** Usar `updateComponentFiles` com functional updates
- **Localiza√ß√£o:** ComponentTab.js linha ~186

#### **Arquivos N√£o Aparecem**
- **Causa:** Thread-safety issues durante parallel uploads
- **Solu√ß√£o:** Usar callback pattern em BudgetReview mode
- **Localiza√ß√£o:** budgetreview/page.js linha ~134

### **3. Monitoramento**
```javascript
// M√©tricas importantes para monitorar:
- Upload success/failure rates
- Average upload time per file size
- Number of parallel uploads
- Progress tracking accuracy
- Memory usage during large file uploads
```

### **4. Configura√ß√µes**
```javascript
// Configura√ß√µes ajust√°veis em ComponentTab.js:
const chunkSize = 10 * 1024 * 1024; // 10MB chunks
const smallFileThreshold = 4 * 1024 * 1024; // 4MB threshold

// Timeout configurations:
tokenManager.registerActiveUpload(tempId); // Session protection
```

---

## üìÅ Estrutura de Arquivos

### **Arquivos Principais**
```
00_frontend/src/components/forms/uploads/
‚îú‚îÄ‚îÄ UploadField.js                    # Componente principal de UI
‚îî‚îÄ‚îÄ ...

00_frontend/src/components/forms/tabs/
‚îú‚îÄ‚îÄ ComponentTab.js                   # L√≥gica de upload e gest√£o de estado
‚îî‚îÄ‚îÄ ...

00_frontend/src/app/order/[orderId]/
‚îú‚îÄ‚îÄ budget/page.js                    # Context: Budget mode
‚îî‚îÄ‚îÄ budgetreview/page.js             # Context: BudgetReview mode

00_frontend/src/app/admin/
‚îî‚îÄ‚îÄ neworder/page.js                 # Context: Admin NewOrder mode

00_frontend/src/app/agent/
‚îî‚îÄ‚îÄ neworder/page.js                 # Context: Agent NewOrder mode
```

### **APIs Relacionadas**
```
01_backend/src/pages/api/
‚îú‚îÄ‚îÄ create-budget-upload-session.js  # Criar sess√£o de upload para budget
‚îú‚îÄ‚îÄ finalize-budget-upload.js        # Finalizar upload para budget
‚îú‚îÄ‚îÄ delete-temp-file.js               # Deletar arquivo tempor√°rio
‚îú‚îÄ‚îÄ get-staged-file-link.js          # Obter link de download para arquivo staged
‚îú‚îÄ‚îÄ delete-budget-file.js            # Deletar arquivo de budget
‚îî‚îÄ‚îÄ get-budget-download-link/        # Obter link de download para arquivo de budget
    ‚îî‚îÄ‚îÄ [budgetFileId].js
```

---

## üîÆ Futuras Melhorias

### **1. Performance**
- **WebWorkers:** Para processar uploads em background thread
- **Service Workers:** Para uploads offline e retry autom√°tico
- **Compression:** Compress√£o de arquivos antes do upload
- **Delta Uploads:** Upload apenas de partes modificadas

### **2. UX**
- **Drag & Drop Melhorado:** Feedback visual durante drag over
- **Bulk Operations:** Sele√ß√£o m√∫ltipla para opera√ß√µes em batch
- **Preview:** Visualiza√ß√£o de arquivos antes do upload
- **Metadata Editing:** Edi√ß√£o de nome/descri√ß√£o durante upload

### **3. Reliability**
- **Auto-retry:** Retry autom√°tico de uploads falhos
- **Bandwidth Detection:** Ajuste autom√°tico de chunk size baseado na velocidade
- **Network Resilience:** Pausa/resume autom√°tico em problemas de rede
- **Integrity Checks:** Verifica√ß√£o de integridade p√≥s-upload

---

## üìù Conclus√£o

O sistema de uploads paralelos representa uma melhoria significativa na experi√™ncia do usu√°rio e performance da aplica√ß√£o. A implementa√ß√£o thread-safe e o feedback visual preciso garantem uma experi√™ncia robusta e confi√°vel para todos os contextos de uso.

**Benef√≠cios Principais:**
- ‚úÖ Velocidade 3-5x mais r√°pida
- ‚úÖ Progress tracking funcional
- ‚úÖ Thread-safety completa
- ‚úÖ Compatibilidade com todos os contextos
- ‚úÖ Error handling robusto
- ‚úÖ C√≥digo manuten√≠vel e extens√≠vel

O sistema est√° preparado para escalar e pode ser facilmente estendido com novas funcionalidades conforme necess√°rio. 